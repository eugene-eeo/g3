#!/usr/bin/env python

from pathlib import Path
from os.path import join
import sys
import json


class Link:
    def __init__(self, target, text):
        self.target = target
        self.text = text
        self.sub = []

    def to_html(self):
        a = "<a href='%s'>%s</a>" % (self.target, self.text)
        if not self.sub:
            return a
        g = [a, '<ul>']
        for l in self.sub:
            g.append('<li>%s</li>' % l.to_html())
        g.append('</ul>')
        return '\n'.join(g)


def strip_tmp_ext(p):
    # strip the leading _g3/tmp from p
    p = p.parent / p.stem
    return Path(join(*p.parts[2:]))


def to_target(p):
    return '/' + str(p)


def files_to_link(p):
    for f in p.iterdir():
        if f.match('*.header'):
            if f.stem == 'index':
                continue
            yield f.parent / f.stem
        if f.is_dir():
            yield f / 'index'


def linkify_directory(p, next):
    links = []
    next_root = None
    for base in files_to_link(p):
        link = Link(
            target=to_target(strip_tmp_ext(base)) + '.html',
            text=json.load(open(str(base) + '.header'))['title'],
            )
        links.append(link)
        if next == base.parent:
            next_root = link
    return links, next_root


def main(path):
    path = Path(path)
    if path.suffix != '.md':
        return

    dst = Path('_g3/tmp') / (str(path.parent / path.stem) + '.menu')
    parts = [Path('_g3/tmp')] + list(path.parts[:-1])
    root = Link(
        target='/index.html',
        text=json.load(open('_g3/tmp/index.header', 'r'))['title'],
        )
    link = root

    for i in range(len(parts)):
        next = None
        if i + 1 < len(parts):
            next = Path.joinpath(*parts[:i+2])
        link.sub, link = linkify_directory(
            Path.joinpath(*parts[:i+1]),
            next,
            )

    with dst.open('w') as f:
        f.write(root.to_html())


if __name__ == '__main__':
    main(sys.argv[1])
