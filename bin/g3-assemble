#!/usr/bin/env python

import sys
import json
from path import Path
from pystache import parse, Renderer


def render(values):
    r = Renderer()
    with Path('_g3/skin.html').open('r') as fp:
        return r.render(
            parse(fp.read()),
            values,
            )


def main(path):
    base, ext = Path(path).splitext()
    if ext != '.md':
        return

    dst = Path('_g3') / 'dst' / base + '.html'
    dir, _ = dst.splitpath()
    dir.makedirs_p()

    menu = Path('_g3') / 'tmp' / base + '.menu'
    headers = Path('_g3') / 'tmp' / base + '.header'
    content = Path('_g3') / 'tmp' / base + '.render'

    with dst.open('w') as w:
        data = json.load(headers.open('r'))
        data['menu'] = menu.open('r').read()
        data['content'] = content.open('r').read()
        w.write(render(data))



if __name__ == '__main__':
    main(sys.argv[1])
